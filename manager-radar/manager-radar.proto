syntax = "proto3";

package radar;

option go_package = "gl.npo-its.ru/radar/proto-radar";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

service RadarService {
  // Методы для работы с радарами
  rpc CreateRadar(CreateRadarRequest) returns (RadarResponse);
  rpc UpdateRadar(UpdateRadarRequest) returns (RadarResponse);
  rpc GetRadar(IdRequest) returns (RadarResponse);
  rpc GetAllRadars(google.protobuf.Empty) returns (RadarsResponse);
  rpc DeleteRadar(IdRequest) returns (RadarResponse);

  // Методы для работы с радарами и полосами
  rpc CreateEmptyRadarWithLanes(google.protobuf.Empty) returns (RadarWithLanesResponse);
  rpc CreateRadarWithLanes(CreateRadarWithLanesRequest) returns (RadarWithLanesResponse);
  rpc UpdateRadarWithLanes(UpdateRadarWithLanesRequest) returns (RadarWithLanesResponse);
  rpc GetRadarWithLanesForSerial(SerialRequest) returns (RadarWithLanesResponse);
  rpc GetRadarWithLanesForId(IdRequest) returns (RadarWithLanesResponse);
  rpc GetAllRadarsWithLanes(google.protobuf.Empty) returns (RadarsWithLanesResponse);
  rpc DeleteRadarWithLanesForSerial(SerialRequest) returns (SerialResponse);
  rpc DeleteRadarWithLanesForId(IdRequest) returns (SerialResponse);

  // Методы для справочников
  rpc GetTimeZones(google.protobuf.Empty) returns (TimeZonesResponse);
  rpc GetRadarModels(google.protobuf.Empty) returns (RadarModelsResponse);
  rpc GetDirectionTypes(google.protobuf.Empty) returns (GetDirectionTypesResponse);

  // Методы для работы с устройством (Пуид)
  rpc GetDevice(google.protobuf.Empty) returns (DeviceResponse);
  rpc UpdateDevice(UpdateDeviceRequest) returns (DeviceResponse);

  // Методы для работы с транспортными объектами
  rpc GetTransportObjectInfo(GetTransportObjectInfoRequest) returns (GetTransportObjectInfoResponse);

  // Методы для работы с экспортами
  rpc GetExportsTypes(google.protobuf.Empty) returns (GetExportTypesResponse);
  rpc GetExportStatuses(google.protobuf.Empty) returns (GetExportStatusesResponse);
  rpc CreateExport(CreateExportRequest) returns (ExportResponse);
  rpc UpdateExport(UpdateExportRequest) returns (ExportResponse);
  rpc GetExport(IdRequest) returns (ExportResponse);
  rpc GetAllExports(google.protobuf.Empty) returns (ExportsResponse);
  rpc DeleteExport(IdRequest) returns (ExportIdResponse);
  rpc ChangeExportState(ChangeExportStateRequest) returns (ChangeExportStateResponse);
  rpc GetExportEvents(GetExportsEventsRequest) returns (GetExportsEventsResponse);

  // Методы для работы с полосами
  rpc CreateLane(CreateLaneRequest) returns (LaneResponse);
  rpc UpdateLane(UpdateLaneRequest) returns (LaneResponse);
  rpc GetLane(LaneRequest) returns (LaneResponse);
  rpc GetAllLanes(LanesRequest) returns (LanesResponse);
  rpc DeleteLane(LaneRequest) returns (IdResponse);

  // Методы для работы с сенсорами
  rpc CreateSensor(CreateSensorRequest) returns (CreateSensorResponse);
  rpc UpdateSensor(UpdateSensorRequest) returns (UpdateSensorResponse);
  rpc GetAllSensor(google.protobuf.Empty) returns (GetAllSensorResponse);

  // Методы для работы с фиксационными линиями (рубежами)
  rpc CreateFixationLine(CreateFixationLineRequest) returns (FixationLineResponse);
  rpc UpdateFixationLine(UpdateFixationLineRequest) returns (FixationLineResponse);
  rpc GetFixationLinesForLane(GetFixationLineRequest) returns (FixationLinesForLaneResponse);
  rpc GetFixationLinesForRadar(GetAllFixationLinesRequest) returns (FixationLinesResponse);
  rpc DeleteFixationLine(GetDeleteFixationLineRequest) returns (DeleteFixationLineResponse);
}

// ==============================
// Общие сообщения
// ==============================

message IdRequest {
  string id = 1;
}

message IdResponse {
  string id = 1;
}

message SerialRequest {
  uint32 serial_number = 1;
}

message SerialResponse {
  string id = 1;
  uint32 serial_number = 2;
}

message Type {
  string id = 1;
  string full_name = 2;
}

message Point2D {
  double x = 1;
  double y = 2;
}

message Point {
  repeated double coords = 1;  // Всегда ровно 2 элемента: [x, y]
}

message PolylineCoords {
  repeated Point points = 1;  // [[x1,y1], [x2,y2], ...]
}

// ==============================
// Сообщения для радаров
// ==============================

message Radar {
  string id = 1;
  string name = 2;
  double lat = 3;
  double lon = 4;
  float azimuth = 5;
  float angle = 6;
  float height = 7;
  optional string direction = 8;
  string address = 9;
  string ip = 10;
  string serial = 11;
  string model = 12;
}

message CreateRadarRequest {
  Radar radar = 1;
}

message UpdateRadarRequest {
  string id = 1;
  Radar radar = 2;
}

message RadarResponse {
  Radar radar = 1;
}

message RadarsResponse {
  repeated Radar radars = 1;
}

// ==============================
// Сообщения для справочников
// ==============================

message TimeZone {
  string id = 1;
  string full_name = 2;
  string time_zone = 3;
}

message TimeZonesResponse {
  repeated TimeZone time_zones = 1;
}

message RadarModel {
  string id = 1;
  string alias = 2;
  string model_name = 3;
  string manufacturer = 4;
}

message RadarModelsResponse {
  repeated RadarModel models = 1;
}

message GetDirectionTypesResponse {
  repeated Type types = 1;
}

// ==============================
// Сообщения для устройства (Пуид)
// ==============================

message Device {
  string id = 1;
  string name = 2;
  string address = 3;
  double lat = 4;
  double lon = 5;
  string serial = 6;
  google.protobuf.Timestamp production_date = 7;
  optional string note = 8;
}

message DeviceResponse {
  Device device = 1;
}

message UpdateDeviceRequest {
  Device device = 1;
}

// ==============================
// Сообщения для транспортных объектов
// ==============================

message RecognitionsFilter {
  repeated uint32 serial_number = 1;
  double heading_from = 2;
  double heading_to = 3;
  double length_from = 4;
  double length_to = 5;
  double speed_from = 6;
  double speed_to = 7;
  int64 date_from = 8;
  int64 date_to = 9;
  string sorting = 10;        // "asc" or "desc"
  string sorting_column = 11;
}

message GetTransportObjectInfoRequest {
  int64 page = 1;
  int64 pageSize = 2;
  RecognitionsFilter filter = 3;
}

message TransportObjectInfo {
  string id = 1;
  uint32 serial_number = 2;
  string origin_id = 3;
  bytes coordinates = 4;  // JSON-encoded координаты
  string color = 5;
  double speed = 6;
  double heading = 7;
  double length = 8;
  int64 date = 9;
  google.protobuf.Timestamp created_at = 10;
  int64 number_lane = 11;
}

message GetTransportObjectInfoResponse {
  repeated TransportObjectInfo data = 1;
  int32 page = 2;
  int32 page_size = 3;
  int64 total_items = 4;
}

// ==============================
// Сообщения для экспортов
// ==============================

message ExportTypeParam {
  string field = 1;
}

message ExportType {
  string id = 1;
  string full_name = 2;
  repeated ExportTypeParam parameters = 3;
}

message GetExportTypesResponse {
  repeated ExportType types = 1;
}

message GetExportStatusesResponse {
  repeated Type statuses = 1;
}

message Export {
  string id = 1;
  string name = 2;
  string export_type = 3 [json_name = "exportType"];
  int32 interval = 4;
  optional string host = 5;
  optional string port = 6;
  optional string login = 7;
  optional string password = 8;
  optional string queue = 9;
  optional string virtual_host = 10 [json_name = "virtualHost"];
  optional string routing_key = 11 [json_name = "routingKey"];
  optional string exchange = 12;
}

message ListExport {
  string id = 1;
  string name = 2;
  string export_type = 3;
  string host = 4;
  string port = 5;
  bool export_on = 6;
}

message ExportEvent {
  string id = 1;
  string export_id = 2;
  int64 date = 3;
  string name = 4;
  int64 export_start_date = 5;
  int64 export_finish_date = 6;
  string export_status = 7;
}

message ExportsEventsFilter {
  repeated string export_ids = 1;
  repeated string statuses = 2;
  int64 export_start_date_from = 3;
  int64 export_start_date_to = 4;
}

message GetExportsEventsRequest {
  int64 page = 1;
  int64 pageSize = 2;
  ExportsEventsFilter filter = 3;
}

message GetExportsEventsResponse {
  repeated ExportEvent exportsEvents = 1;
  int64 page = 2;
  int64 page_size = 3;
  int64 total_items = 4;
}

message ExportResponse {
  Export export = 1;
}

message ExportIdResponse {
  string exportId = 1;
}

message ExportsResponse {
  repeated ListExport exports = 1;
}

message CreateExportRequest {
  Export export = 1;
}

message UpdateExportRequest {
  Export export = 1;
}

message ChangeExportStateRequest {
  string id = 1;
  bool export_on = 2;
}

message ChangeExportStateResponse {
  string id = 1;
  bool export_on = 2;
}

// ==============================
// Сообщения для полос
// ==============================

message Lane {
  string id = 1;
  string name = 2;
  string direction = 3;
  PolylineCoords coords = 4;
  float width = 5;
}

message LaneResponse {
  Lane lane = 1;
}

message LanesResponse {
  repeated Lane lanes = 1;
}

message LaneRequest {
  string id = 1;
  string radarId = 2;
}

message LanesRequest {
  string radarId = 1;
}

message CreateLaneRequest {
  string radarId = 1;
  Lane lane = 2;
}

message UpdateLaneRequest {
  string radarId = 1;
  Lane lane = 2;
}

// ==============================
// Сообщения для радаров с полосами
// ==============================

message SensorControlPoints {
  Point2D length_start = 1;
  Point2D length_end = 2;
  Point2D width_start = 3;
  Point2D width_end = 4;
  Point2D move_control = 5;
  Point2D curve_control = 6;
}

message SensorLane {
  string id = 1;
  string name = 2;
  int32 direction = 3;
  repeated Point2D coords = 4;
  repeated Point2D polygon = 5;
  repeated Point2D arrow_points = 6;
  SensorControlPoints control_points = 7;
  float width = 8;
  int32 number_lane = 9;
  repeated FixationLine fixation_lines = 10;
}

message RadarWithLanes {
  string id = 1;
  string name = 2;
  double lat = 3;
  double lon = 4;
  repeated double coords = 5;    // массив float64
  float azimuth = 6;
  float angle = 7;
  double height = 8;
  string direction = 9;
  string address = 10;
  string ip = 11;
  string serial = 12;
  string model = 13;
  int32 waveform_selector = 14;  // 100 waveform_selector (выбор формы сигнала)
  int32 tx_power_selector = 15;  // 104 (уровень мощности передатчика)
  repeated SensorLane lanes = 16;
  uint32 serial_number = 17;
}

message CreateRadarWithLanesRequest {
  RadarWithLanes radar = 1;
}

message UpdateRadarWithLanesRequest {
  uint32 serial_number = 1;
  string id = 2;
  RadarWithLanes radar = 3;
}

message RadarWithLanesResponse {
  RadarWithLanes radar = 1;
}

message RadarsWithLanesResponse {
  repeated RadarWithLanes radars = 1;
}

// ==============================
// Сообщения для сенсоров
// ==============================

message Sensor {
  string id = 1;
  uint32 serial_number = 2;
  string ip = 3;
  int32 port = 4;
}

message CreateSensorRequest {
  Sensor sensor = 1;
}

message CreateSensorResponse {
  Sensor sensor = 1;
}

message UpdateSensorRequest {
  Sensor sensor = 1;
}

message UpdateSensorResponse {
  Sensor sensor = 1;
}

message GetAllSensorResponse {
  repeated Sensor sensors = 1;
}

// ==============================
// Сообщения для фиксационных линий
// ==============================

message FixationLine {
  string id = 1;
  string radar_id = 2;
  string lane_id = 3;
  double p1_x = 4;
  double p1_y = 5;
  double p2_x = 6;
  double p2_y = 7;
  bool is_deleted = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

message GetDeleteFixationLineRequest {
  string radar_id = 1;
  string lane_id = 2;
}

message GetFixationLineRequest {
  string radar_id = 1;
  string lane_id = 2;
}

message GetAllFixationLinesRequest {
  string radar_id = 1;
}

message FixationLinesResponse {
  repeated FixationLine fixation_lines = 1;
}

message FixationLinesForLaneResponse {
  repeated FixationLine fixation_lines = 1;
}

message DeleteFixationLineResponse {
  bool success = 1;
  string message = 2;
}

message FixationLineResponse {
  FixationLine fixation_line = 1;
}

message CreateFixationLineRequest {
  string radar_id = 1;
  string lane_id = 2;
  double p1_x = 3;
  double p1_y = 4;
  double p2_x = 5;
  double p2_y = 6;
}

message UpdateFixationLineRequest {
  string radar_id = 1;
  string lane_id = 2;
  double p1_x = 3;
  double p1_y = 4;
  double p2_x = 5;
  double p2_y = 6;
}